name: Build Webview Binaries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: linux-x86-gnu
            arch: i686
            toolchain: gcc
            libc: gnu
          - target: linux-x86_64-gnu
            arch: x86_64
            toolchain: gcc
            libc: gnu
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libgtk-4-dev libwebkitgtk-6.0-dev
        
        # Install 32-bit development libraries for x86 targets
        if [[ "${{ matrix.arch }}" == "i686" ]]; then
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib libc6-dev-i386
        fi
  
    - name: Create build directories
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}/core/amalgamation
        chmod -R 755 build-${{ matrix.target }}
    
    - name: Build
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        cmake .. -DCMAKE_BUILD_TYPE=Release \
                 -DWEBVIEW_BUILD_DOCS=OFF \
                 -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                 -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        
        cmake --build . --config Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.so
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-linux-musl:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: linux-x86-musl
            arch: x86
            alpine_arch: 386
          - target: linux-x86_64-musl
            arch: x86_64
            alpine_arch: amd64
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: all
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build in Alpine container
      run: |
        docker run --rm --platform linux/${{ matrix.alpine_arch }} \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace/webview \
          alpine:latest \
          sh -c '
            # Install build dependencies
            apk add --no-cache \
              cmake \
              make \
              gcc \
              g++ \
              musl-dev \
              linux-headers \
              gtk+3.0-dev \
              webkit2gtk-4.1-dev \
              pkgconfig
            
            # Create build directory
            mkdir -p build-${{ matrix.target }}
            cd build-${{ matrix.target }}
            
            # Configure and build
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DWEBVIEW_BUILD_DOCS=OFF \
              -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
              -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
            
            cmake --build . --config Release
            
            # Verify the build
            echo "Build completed for ${{ matrix.target }}"
            find . -name "*.a" -o -name "*.so" -o -name "webview" -type f
          '
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.so
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-linux-arm-musl:
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        include:
          - target: linux-aarch64-musl
            arch: aarch64
            alpine_arch: arm64
          - target: linux-arm-musl
            arch: armv7
            alpine_arch: arm/v7
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: all
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build in Alpine container
      run: |
        docker run --rm --platform linux/${{ matrix.alpine_arch }} \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace/webview \
          alpine:latest \
          sh -c '
            # Install build dependencies
            apk add --no-cache \
              cmake \
              make \
              gcc \
              g++ \
              musl-dev \
              linux-headers \
              gtk+3.0-dev \
              webkit2gtk-4.1-dev \
              pkgconfig
            
            # Create build directory
            mkdir -p build-${{ matrix.target }}
            cd build-${{ matrix.target }}
            
            # Configure and build
            cmake .. \
              -DCMAKE_BUILD_TYPE=Release \
              -DWEBVIEW_BUILD_DOCS=OFF \
              -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
              -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
            
            cmake --build . --config Release
            
            # Verify the build
            echo "Build completed for ${{ matrix.target }}"
            find . -name "*.a" -o -name "*.so" -o -name "webview" -type f
          '
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.so
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-linux-arm:
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        include:
          - target: linux-aarch64-gnu
            arch: aarch64
            toolchain: gcc
            libc: gnu
          - target: linux-arm-gnu
            arch: armv7l
            toolchain: gcc
            libc: gnu
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libgtk-4-dev libwebkitgtk-6.0-dev
        
        # Install armhf cross-compilation toolchain for 32-bit ARM
        if [[ "${{ matrix.arch }}" == "armv7l" ]]; then
          sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
          
          # Add armhf architecture and install ARM32 GTK/WebKit libraries
          sudo dpkg --add-architecture armhf
          sudo apt-get update
          sudo apt-get install -y libgtk-4-dev:armhf libwebkitgtk-6.0-dev:armhf clang-format
        fi
    
    - name: Create build directories
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}/core/amalgamation
        chmod -R 755 build-${{ matrix.target }}
    
    - name: Build
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        # Set up cross-compilation for armv7l (32-bit ARM)
        if [[ "${{ matrix.arch }}" == "armv7l" ]]; then
          export CC=arm-linux-gnueabihf-gcc
          export CXX=arm-linux-gnueabihf-g++
          export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
          
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc \
                   -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++ \
                   -DCMAKE_SYSTEM_NAME=Linux \
                   -DCMAKE_SYSTEM_PROCESSOR=arm \
                   -DWEBVIEW_BUILD_DOCS=OFF \
                   -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                   -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        else
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DWEBVIEW_BUILD_DOCS=OFF \
                   -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                   -DWEBVIEW_ENABLE_CLANG_TIDY=OFF \
                   -DClangFormat_DIR=/usr/bin
        fi
        
        cmake --build . --config Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.so
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: mac-x86_64
            arch: x86_64
          - target: mac-aarch64
            arch: arm64
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install clang-format
      run: brew install clang-format
    
    - name: Create build directories
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}/core/amalgamation
        chmod -R 755 build-${{ matrix.target }}
    
    - name: Build
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        cmake .. -DCMAKE_BUILD_TYPE=Release \
                 -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
                 -DWEBVIEW_BUILD_DOCS=OFF \
                 -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                 -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        cmake --build . --config Release -- -j$(sysctl -n hw.ncpu)
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.dylib
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: windows-x86
            arch: Win32
            platform: x86
          - target: windows-x86_64
            arch: x64
            platform: x64
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Install Graphviz (for Doxygen)
      run: choco install graphviz -y
    
    - name: Build
      run: |
        cd webview
        mkdir build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        cmake .. -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Release -DWEBVIEW_BUILD_DOCS=OFF -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF
        cmake --build . --config Release
    
    - name: List build outputs
      run: |
        echo "Build directory contents:"
        cd  webview\build-${{ matrix.target }}  && ls && cd ../..
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.dll
          webview/build-${{ matrix.target }}/**/*.lib
          webview/build-${{ matrix.target }}/**/*.exe
        if-no-files-found: warn

  deploy-libraries:
    needs: [build-linux, build-linux-musl, build-linux-arm-musl, build-linux-arm, build-macos, build-windows]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display downloaded artifacts
      run: |
        echo "Downloaded artifacts:"
        find artifacts -type f \( -name "*.so" -o -name "*.dll" -o -name "*.dylib" \)
    
    - name: Copy libraries to module directories
      run: |
        # Function to find and copy webview library
        copy_lib() {
          local artifact_name=$1
          local dest_path=$2
          local extension=$3
          
          echo "Processing $artifact_name -> $dest_path"
          
          # Create destination directory
          mkdir -p "$dest_path"
          
          # Find the library file (exact name: webview.extension)
          lib_file=$(find "artifacts/webview-$artifact_name" -type f -name "webview.$extension" | head -n 1)
          
          if [ -n "$lib_file" ]; then
            echo "Found: $lib_file"
            cp "$lib_file" "$dest_path/"
            echo "Copied to: $dest_path/"
          else
            echo "WARNING: No library found for $artifact_name with extension $extension"
          fi
        }
        
        # Linux GNU
        copy_lib "linux-x86-gnu" "avaje-webview-linux-x86-gnu/src/main/resources/io/avaje/webview/nativelib/linux/x86/gnu" "so"
        copy_lib "linux-x86_64-gnu" "avaje-webview-linux-x86_64-gnu/src/main/resources/io/avaje/webview/nativelib/linux/x86_64/gnu" "so"
        copy_lib "linux-arm-gnu" "avaje-webview-linux-arm-gnu/src/main/resources/io/avaje/webview/nativelib/linux/arm/gnu" "so"
        copy_lib "linux-aarch64-gnu" "avaje-webview-linux-aarch64-gnu/src/main/resources/io/avaje/webview/nativelib/linux/aarch64/gnu" "so"
        
        # Linux MUSL
        copy_lib "linux-x86-musl" "avaje-webview-linux-x86-musl/src/main/resources/io/avaje/webview/nativelib/linux/x86/musl" "so"
        copy_lib "linux-x86_64-musl" "avaje-webview-linux-x86_64-musl/src/main/resources/io/avaje/webview/nativelib/linux/x86_64/musl" "so"
        copy_lib "linux-arm-musl" "avaje-webview-linux-arm-musl/src/main/resources/io/avaje/webview/nativelib/linux/arm/musl" "so"
        copy_lib "linux-aarch64-musl" "avaje-webview-linux-aarch64-musl/src/main/resources/io/avaje/webview/nativelib/linux/aarch64/musl" "so"
        
        # macOS
        copy_lib "mac-x86_64" "avaje-webview-mac-x86_64/src/main/resources/io/avaje/webview/nativelib/macos/x86_64" "dylib"
        copy_lib "mac-aarch64" "avaje-webview-mac-aarch64/src/main/resources/io/avaje/webview/nativelib/macos/aarch64" "dylib"
        
        # Windows
        copy_lib "windows-x86" "avaje-webview-windows-x86/src/main/resources/io/avaje/webview/nativelib/windows_nt/x86" "dll"
        copy_lib "windows-x86_64" "avaje-webview-windows-x86_64/src/main/resources/io/avaje/webview/nativelib/windows_nt/x86_64" "dll"
    
    - name: Check for changes
      id: check_changes
      run: |
        git add avaje-webview-*/src/main/resources/
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected:"
          git diff --staged --name-only
        fi
    
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Update webview native libraries"
        title: "Update webview native libraries"
        body: |
          This PR updates the webview native libraries for all platforms.
          
          Built libraries for:
          - Linux (x86, x86_64, ARM, AArch64) with GNU and musl libc
          - macOS (x86_64, AArch64)
          - Windows (x86, x86_64)
          
          Auto-generated by the Build Webview Binaries workflow.
        branch: update-webview-binaries-${{ github.run_number }}
        delete-branch: true
        labels: |
          automated
          native-libraries