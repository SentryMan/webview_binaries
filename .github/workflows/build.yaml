name: Build Webview Binaries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: linux-x86-gnu
            arch: i686
            toolchain: gcc
            libc: gnu
          - target: linux-x86_64-gnu
            arch: x86_64
            toolchain: gcc
            libc: gnu
          - target: linux-aarch64-gnu
            arch: aarch64
            toolchain: gcc
            libc: gnu
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libgtk-4-dev libwebkitgtk-6.0-dev
        
        # Install 32-bit development libraries for x86 targets
        if [[ "${{ matrix.arch }}" == "i686" ]]; then
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib libc6-dev-i386
        fi
        
        # Install aarch64 cross-compilation toolchain
        if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        fi
    
    - name: Create build directories
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}/core/amalgamation
        chmod -R 755 build-${{ matrix.target }}
    
    - name: Create aarch64 toolchain file
      if: matrix.arch == 'aarch64'
      run: |
        cat > aarch64-toolchain.cmake << 'EOF'
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR aarch64)
        
        set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
        set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
        
        set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        
        # Clear any default flags that might contain x86-specific options
        set(CMAKE_C_FLAGS_INIT "")
        set(CMAKE_CXX_FLAGS_INIT "")
        set(CMAKE_C_FLAGS "")
        set(CMAKE_CXX_FLAGS "")
        EOF
    
    - name: Patch CMakeLists for aarch64
      if: matrix.arch == 'aarch64'
      run: |
        cd webview
        # Remove x86-specific compiler flags from CMakeLists files
        find . -name "CMakeLists.txt" -type f -exec sed -i 's/-msse//g; s/-msse2//g; s/-mfpmath=sse//g; s/-march=native//g; s/-mtune=native//g' {} +
        find . -name "*.cmake" -type f -exec sed -i 's/-msse//g; s/-msse2//g; s/-mfpmath=sse//g; s/-march=native//g; s/-mtune=native//g' {} +
    
    - name: Build
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        # Set up cross-compilation for aarch64
        if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
          export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_TOOLCHAIN_FILE=../../aarch64-toolchain.cmake \
                   -DWEBVIEW_BUILD_DOCS=OFF \
                   -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                   -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        else
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DWEBVIEW_BUILD_DOCS=OFF \
                   -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                   -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        fi
        
        cmake --build . --config Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.so
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: mac-x86_64
            arch: x86_64
          - target: mac-aarch64
            arch: arm64
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install clang-format
      run: brew install clang-format
    
    - name: Create build directories
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}/core/amalgamation
        chmod -R 755 build-${{ matrix.target }}
    
    - name: Build
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        cmake .. -DCMAKE_BUILD_TYPE=Release \
                 -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
                 -DWEBVIEW_BUILD_DOCS=OFF \
                 -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                 -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        cmake --build . --config Release -- -j$(sysctl -n hw.ncpu)
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.dylib
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: windows-x86
            arch: Win32
            platform: x86
          - target: windows-x86_64
            arch: x64
            platform: x64
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Install Graphviz (for Doxygen)
      run: choco install graphviz -y
    
    - name: Build
      run: |
        cd webview
        mkdir build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        cmake .. -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Release -DWEBVIEW_BUILD_DOCS=OFF -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF
        cmake --build . --config Release
    
    - name: List build outputs
      run: |
        echo "Build directory contents:"
        cd  webview\build-${{ matrix.target }}  && ls && cd ../..
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.dll
          webview/build-${{ matrix.target }}/**/*.lib
          webview/build-${{ matrix.target }}/**/*.exe
        if-no-files-found: warn

  create-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure
      run: ls -R artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: artifacts/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}