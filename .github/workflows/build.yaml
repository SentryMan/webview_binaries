name: Build Webview Binaries

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: linux-x86-gnu
            arch: i686
            toolchain: gcc
            libc: gnu
          - target: linux-x86-musl
            arch: i686
            toolchain: musl
            libc: musl
          - target: linux-x86_64-gnu
            arch: x86_64
            toolchain: gcc
            libc: gnu
          - target: linux-x86_64-musl
            arch: x86_64
            toolchain: musl
            libc: musl
          - target: linux-arm-gnu
            arch: armv7
            toolchain: gcc
            libc: gnu
            cross_triple: arm-linux-gnueabihf
          - target: linux-arm-musl
            arch: armv7
            toolchain: musl
            libc: musl
            cross_triple: arm-linux-musleabihf
          - target: linux-aarch64-gnu
            arch: aarch64
            toolchain: gcc
            libc: gnu
            cross_triple: aarch64-linux-gnu
          - target: linux-aarch64-musl
            arch: aarch64
            toolchain: musl
            libc: musl
            cross_triple: aarch64-linux-musl
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libgtk-3-dev libwebkit2gtk-4.1-dev
        
        # Install 32-bit development libraries for x86 targets
        if [[ "${{ matrix.arch }}" == "i686" ]]; then
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib libc6-dev-i386
        fi
        
        # Install cross-compilation toolchains if needed
        if [[ "${{ matrix.arch }}" == "armv7" ]] || [[ "${{ matrix.arch }}" == "aarch64" ]]; then
          if [[ "${{ matrix.libc }}" == "gnu" ]]; then
            sudo apt-get install -y gcc-${{ matrix.cross_triple }} g++-${{ matrix.cross_triple }}
            
            # Install cross-compilation libraries for ARM targets
            if [[ "${{ matrix.arch }}" == "armv7" ]]; then
              sudo apt-get install -y libgtk-3-dev:armhf libwebkit2gtk-4.1-dev:armhf crossbuild-essential-armhf
              sudo dpkg --add-architecture armhf
              sudo apt-get update
            elif [[ "${{ matrix.arch }}" == "aarch64" ]]; then
              sudo apt-get install -y libgtk-3-dev:arm64 libwebkit2gtk-4.1-dev:arm64 crossbuild-essential-arm64
              sudo dpkg --add-architecture arm64
              sudo apt-get update
            fi
          fi
        fi
        
        # Install musl tools if needed
        if [[ "${{ matrix.libc }}" == "musl" ]]; then
          if [[ "${{ matrix.arch }}" == "i686" ]]; then
            sudo apt-get install -y musl-tools
          elif [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            sudo apt-get install -y musl-tools
          else
            # For ARM musl targets, download prebuilt toolchain
            wget https://musl.cc/${{ matrix.cross_triple }}-cross.tgz
            tar -xzf ${{ matrix.cross_triple }}-cross.tgz
            echo "$PWD/${{ matrix.cross_triple }}-cross/bin" >> $GITHUB_PATH
          fi
        fi
    
    - name: Create build directories
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}/core/amalgamation
        chmod -R 755 build-${{ matrix.target }}
    
    - name: Build
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        # Set up cross-compilation if needed
        if [[ "${{ matrix.arch }}" == "armv7" ]] || [[ "${{ matrix.arch }}" == "aarch64" ]]; then
          if [[ "${{ matrix.libc }}" == "gnu" ]]; then
            export CC=${{ matrix.cross_triple }}-gcc
            export CXX=${{ matrix.cross_triple }}-g++
            
            # Set up pkg-config for cross-compilation
            if [[ "${{ matrix.arch }}" == "armv7" ]]; then
              export PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig
              export PKG_CONFIG_LIBDIR=/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig
              CMAKE_EXTRA_FLAGS="-DCMAKE_FIND_ROOT_PATH=/usr/arm-linux-gnueabihf -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY"
            elif [[ "${{ matrix.arch }}" == "aarch64" ]]; then
              export PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
              export PKG_CONFIG_LIBDIR=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
              CMAKE_EXTRA_FLAGS="-DCMAKE_FIND_ROOT_PATH=/usr/aarch64-linux-gnu -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY"
            fi
            
            cmake .. -DCMAKE_BUILD_TYPE=Release \
                     -DCMAKE_C_COMPILER=$CC \
                     -DCMAKE_CXX_COMPILER=$CXX \
                     $CMAKE_EXTRA_FLAGS \
                     -DWEBVIEW_BUILD_DOCS=OFF \
                     -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                     -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
          else
            export CC=${{ matrix.cross_triple }}-gcc
            export CXX=${{ matrix.cross_triple }}-g++
            cmake .. -DCMAKE_BUILD_TYPE=Release \
                     -DCMAKE_C_COMPILER=$CC \
                     -DCMAKE_CXX_COMPILER=$CXX \
                     -DWEBVIEW_BUILD_DOCS=OFF \
                     -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                     -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
          fi
        elif [[ "${{ matrix.libc }}" == "musl" ]]; then
          if [[ "${{ matrix.arch }}" == "i686" ]] || [[ "${{ matrix.arch }}" == "x86_64" ]]; then
            # For x86/x86_64 musl, use musl-gcc wrapper if available
            if command -v musl-gcc &> /dev/null; then
              export CC=musl-gcc
              cmake .. -DCMAKE_BUILD_TYPE=Release \
                       -DCMAKE_C_COMPILER=$CC \
                       -DWEBVIEW_BUILD_DOCS=OFF \
                       -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                       -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
            else
              # Fallback to regular gcc
              cmake .. -DCMAKE_BUILD_TYPE=Release \
                       -DWEBVIEW_BUILD_DOCS=OFF \
                       -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                       -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
            fi
          fi
        else
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DWEBVIEW_BUILD_DOCS=OFF \
                   -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                   -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        fi
        
        cmake --build . --config Release
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.so
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - target: mac-x86_64
            arch: x86_64
          - target: mac-aarch64
            arch: arm64
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install clang-format
      run: brew install clang-format
    
    - name: Create build directories
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}/core/amalgamation
        chmod -R 755 build-${{ matrix.target }}
    
    - name: Build
      run: |
        cd webview
        mkdir -p build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        cmake .. -DCMAKE_BUILD_TYPE=Release \
                 -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
                 -DWEBVIEW_BUILD_DOCS=OFF \
                 -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF \
                 -DWEBVIEW_ENABLE_CLANG_TIDY=OFF
        cmake --build . --config Release -- -j$(sysctl -n hw.ncpu)
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.dylib
          webview/build-${{ matrix.target }}/**/*.a
          webview/build-${{ matrix.target }}/**/webview
        if-no-files-found: warn

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: windows-x86
            arch: Win32
            platform: x86
          - target: windows-x86_64
            arch: x64
            platform: x64
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Install Graphviz (for Doxygen)
      run: choco install graphviz -y
    
    - name: Build
      run: |
        cd webview
        mkdir build-${{ matrix.target }}
        cd build-${{ matrix.target }}
        
        cmake .. -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=Release -DWEBVIEW_BUILD_DOCS=OFF -DWEBVIEW_ENABLE_CLANG_FORMAT=OFF
        cmake --build . --config Release
    
    - name: List build outputs
      run: |
        echo "Build directory contents:"
        cd  webview\build-${{ matrix.target }}  && ls && cd ../..
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: webview-${{ matrix.target }}
        path: |
          webview/build-${{ matrix.target }}/**/*.dll
          webview/build-${{ matrix.target }}/**/*.lib
          webview/build-${{ matrix.target }}/**/*.exe
        if-no-files-found: warn

  create-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure
      run: ls -R artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: artifacts/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}